name: Update VS Marketplace badges
on:
  schedule: [{ cron: "0 6 * * *" }]  # daily 06:00 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed to push back to the repo
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Fetch Marketplace data
        env:
          EXT: meterian.meterian-heidi
        run: |
          mkdir -p badges
          curl -s -X POST \
            -H "Accept: application/json;api-version=3.0-preview.1" \
            -H "Content-Type: application/json" \
            https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery \
            --data '{"filters":[{"criteria":[{"filterType":7,"value":"'"$EXT"'"}]}],"flags":914}' \
          > resp.json

          # Extract fields
          INST=$(jq -r '.results[0].extensions[0].statistics[] | select(.statisticName=="install").value' resp.json)
          AVG=$(jq -r '.results[0].extensions[0].statistics[] | select(.statisticName=="averagerating").value' resp.json)
          CNT=$(jq -r '.results[0].extensions[0].statistics[] | select(.statisticName=="ratingcount").value' resp.json)
          VER=$(jq -r '.results[0].extensions[0].versions[0].version' resp.json)

          # Format numbers for display
          numfmt() { awk -v n="$1" 'BEGIN{
            if(n==""||n=="null"){print "n/a"; exit}
            if(n>=1000000) printf("%.1fm", n/1000000);
            else if(n>=1000) printf("%.0fk", n/1000);
            else printf("%.0f", n);
          }'; }

          INST_MSG=$(numfmt "$INST")
          AVG_MSG=$(awk -v a="${AVG:-0}" 'BEGIN{printf("%.1f", a+0)}')
          CNT_MSG=$(numfmt "${CNT:-0}")

          # Build endpoint JSONs (schemaVersion 1)
          printf '{"schemaVersion":1,"label":"installs","message":"%s","color":"blue"}\n' "$INST_MSG" > badges/vscode-installs.json
          printf '{"schemaVersion":1,"label":"version","message":"%s","color":"informational"}\n' "$VER" > badges/vscode-version.json
          printf '{"schemaVersion":1,"label":"rating","message":"%s/5 (%s)","color":"yellow"}\n' "$AVG_MSG" "$CNT_MSG" > badges/vscode-rating.json

          # Validate JSON
          jq empty badges/vscode-*.json

      - name: Commit changes (only if there are changes)
        run: |
          # Stage new/changed files
          git add -A badges

          # If nothing is staged, bail out
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi          if ! git diff --quiet -- badges; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add badges/*.json
            git commit -m "chore(badges): refresh VS Marketplace badges"
            git push
          else
            echo "No changes to commit."
          fi
